<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Donos / Zawiadomienie</title>
    <style>
        .navigation {
            display: inline-block;
            background-color: rgb(16, 59, 107);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-family: sans-serif;
            text-decoration: none;
        }

        .navigation:hover {
            background-color: aqua;
            color: black;
        }

        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding-top: 50px;
            background-color: lightgray;
        }

        form {
            display: inline-block;
            text-align: left;
            background: white;
            padding: 20px;
            border-radius: 8px;
        }

        label {
            display: block;
            margin-top: 20px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="date"],
        textarea {
            width: 300px;
            padding: 5px;
            margin-top: 5px;
        }

        textarea {
            height: 100px;
        }

        button {
            margin-top: 20px;
            padding: 10px 30px;
            font-size: 16px;
        }

        #wynikKomendy {
            margin-top: 15px;
            font-style: italic;
            color: darkblue;
        }
    </style>
</head>
<body>
    <h1>E-DONOS</h1>

    <!-- Nawigacja -->
    <a href="index.html" class="navigation">Strona G≈Ç√≥wna</a>
    <a href="zawiadomienie.html" class="navigation">Zawiadomienie</a>
    <a href="obywatel.html" class="navigation">Obywatel</a>
    <a href="#" class="navigation">Komenda</a>
    <a href="#" class="navigation">Pomoc</a>

    <br><br>

    <!-- Formularz -->
    <form action="zapisz.php" method="post">
        <label for="imie">Imiƒô:</label>
        <input type="text" id="imie" name="imie" required>

        <label for="nazwisko">Nazwisko:</label>
        <input type="text" id="nazwisko" name="nazwisko" required>

        <label for="opis">Opis zdarzenia:</label>
        <textarea id="opis" name="opis" required></textarea>

        <label for="data">Data zdarzenia:</label>
        <input type="date" id="data" name="data" required>

        <!-- Ukryte pole na znalezionƒÖ komendƒô -->
        <input type="hidden" id="komenda" name="komenda">

        <button type="button" id="znajdzKomende">Znajd≈∫ najbli≈ºszƒÖ komendƒô policji</button>
        <div id="wynikKomendy"></div>

        <button type="submit">Wy≈õlij</button>
    </form>

    <p>
        <a href="index.html" class="navigation">Powr√≥t do strony g≈Ç√≥wnej</a>
    </p>

    <script>
// Obliczanie odleg≈Ço≈õci w metrach miƒôdzy dwoma punktami (Haversine)
function odlegloscMetry(lat1, lon1, lat2, lon2) {
    const R = 6371000; // promie≈Ñ Ziemi w metrach
    const toRad = deg => deg * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// Funkcja zapytania Overpass API
async function zapytajOverpass(lat, lon, radius) {
    const query = `
[out:json][timeout:45];
(
  node["amenity"="policja"](around:${radius},${lat},${lon});
  way["amenity"="policja"](around:${radius},${lat},${lon});
  relation["amenity"="policja"](around:${radius},${lat},${lon});
);
out center;
`;
    const url = 'https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query);
    try {
        const resp = await fetch(url);
        const data = await resp.json();
        console.log(`Overpass response (radius ${radius} m):`, data.elements);
        console.log(`LAT: ${lat}, LON: ${lon}, radius: ${r}`);
console.log('Query URL:', url);

        return data.elements || [];
    } catch (e) {
        console.error("B≈ÇƒÖd zapytania Overpass:", e);
        return [];
    }
}

// G≈Ç√≥wna funkcja wyszukiwania najbli≈ºszej komendy
async function znajdzNajblizszaKomende() {
    const wynikDiv = document.getElementById('wynikKomendy');
    if (!wynikDiv) {
        console.error("Brak elementu #wynikKomendy w HTML!");
        return;
    }

    wynikDiv.textContent = 'üìç Pobieram TwojƒÖ lokalizacjƒô...';

    if (!navigator.geolocation) {
        wynikDiv.textContent = 'Twoja przeglƒÖdarka nie wspiera geolokalizacji.';
        return;
    }

    const pozycja = await new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 100000,
            maximumAge: 0
        });
    }).catch(err => {
    console.error('Nie uda≈Ço siƒô pobraƒá lokalizacji:', err);
    wynikDiv.textContent = 'Nie uda≈Ço siƒô pobraƒá lokalizacji. Spr√≥buj ponownie lub u≈ºyj lokalizacji rƒôcznej.';
    return null;
});


    if (!pozycja) return;

    const lat = pozycja.coords.latitude;
    const lon = pozycja.coords.longitude;

    const radii = [10000, 20000, 50000]; // wiƒôksze promienie od razu
    let znalezione = [];

    for (const r of radii) {
        wynikDiv.textContent = `üîç Szukam komend w promieniu ${r} m...`;
        const wyniki = await zapytajOverpass(lat, lon, r);
        console.log(`RADIUS ${r}:`, wyniki);
        if (wyniki.length > 0) {
            znalezione = wyniki;
            break;
        }
    }

    if (znalezione.length === 0) {
        wynikDiv.textContent = 'üö´ Nie znaleziono komendy w pobli≈ºu.';
        return;
    }

    const komendy = znalezione.map(el => {
        const elLat = el.lat !== undefined ? el.lat : el.center?.lat;
        const elLon = el.lon !== undefined ? el.lon : el.center?.lon;
        if (elLat === undefined || elLon === undefined) return null; // pomi≈Ñ brakujƒÖce dane
        const name = el.tags?.name || 'Komenda Policji';
        return {
            name,
            lat: elLat,
            lon: elLon,
            distance: odlegloscMetry(lat, lon, elLat, elLon)
        };
    }).filter(el => el !== null); // usu≈Ñ null

    if (komendy.length === 0) {
        wynikDiv.textContent = 'üö´ Nie uda≈Ço siƒô wyznaczyƒá wsp√≥≈Çrzƒôdnych ≈ºadnej komendy.';
        return;
    }

    komendy.sort((a, b) => a.distance - b.distance);
    const najblizsza = komendy[0];

    wynikDiv.innerHTML = `
        ‚úÖ <b>${najblizsza.name}</b><br>
        Odleg≈Ço≈õƒá: ${Math.round(najblizsza.distance)} m<br>
        <a href="https://www.openstreetmap.org/?mlat=${najblizsza.lat}&mlon=${najblizsza.lon}#map=18/${najblizsza.lat}/${najblizsza.lon}" target="_blank">Poka≈º na mapie</a>
    `;

    const poleKomenda = document.getElementById('komenda');
    if (poleKomenda) poleKomenda.value = najblizsza.name;
}

// Przycisk do wywo≈Çania wyszukiwania
document.getElementById('znajdzKomende').addEventListener('click', znajdzNajblizszaKomende);
</script>

</body>
</html>
